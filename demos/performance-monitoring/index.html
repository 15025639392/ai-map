<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ€§èƒ½ç›‘æ§ - WebGL2 æ¸²æŸ“å¼•æ“</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        #container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 20px;
            max-width: 1000px;
            width: 100%;
        }

        canvas {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            display: block;
            margin: 0 auto;
        }

        .controls {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        button {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            background: #667eea;
            color: white;
            font-size: 14px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        .stats-panel {
            margin-top: 20px;
            background: #f5f5f5;
            border-radius: 6px;
            padding: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }

        .stat-unit {
            font-size: 12px;
            color: #999;
            margin-left: 4px;
        }

        .chart-container {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 15px;
        }

        .chart-title {
            font-size: 14px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }

        .chart {
            height: 120px;
            display: flex;
            align-items: flex-end;
            gap: 2px;
            background: linear-gradient(to top, #f5f5f5 0%, #f5f5f5 100%);
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            padding: 5px;
            overflow: hidden;
        }

        .chart-bar {
            flex: 1;
            background: linear-gradient(to top, #667eea 0%, #764ba2 100%);
            border-radius: 2px;
            transition: height 0.3s;
            min-height: 2px;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
            margin-top: 10px;
        }

        .history-table th,
        .history-table td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        .history-table th {
            background: #667eea;
            color: white;
            font-weight: bold;
        }

        .history-table tr:hover {
            background: #f5f5f5;
        }

        .status-good {
            color: #4caf50;
            font-weight: bold;
        }

        .status-warning {
            color: #ff9800;
            font-weight: bold;
        }

        .status-bad {
            color: #f44336;
            font-weight: bold;
        }

        h1 {
            color: white;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
    </style>
</head>
<body>
    <h1>ğŸ“Š æ€§èƒ½ç›‘æ§ - WebGL2 æ¸²æŸ“å¼•æ“</h1>
    <div id="container">
        <canvas id="canvas" width="800" height="600"></canvas>

        <div class="controls">
            <button onclick="increaseLoad()">å¢åŠ è´Ÿè½½</button>
            <button onclick="decreaseLoad()">å‡å°‘è´Ÿè½½</button>
            <button onclick="togglePause()">æš‚åœ/æ¢å¤</button>
            <button onclick="clearHistory()">æ¸…ç©ºå†å²</button>
        </div>

        <div class="stats-panel">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">FPS</div>
                    <div class="stat-value" id="fps">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">å¸§æ—¶é—´</div>
                    <div class="stat-value" id="frameTime">0<span class="stat-unit">ms</span></div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">èŠ‚ç‚¹æ•°</div>
                    <div class="stat-value" id="nodeCount">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">èµ„æºæ•°</div>
                    <div class="stat-value" id="resourceCount">0</div>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-title">FPS å†å²è¶‹åŠ¿ï¼ˆæœ€è¿‘ 60 å¸§ï¼‰</div>
                <div class="chart" id="fpsChart"></div>
            </div>

            <div class="chart-container">
                <div class="chart-title">å¸§æ—¶é—´å†å²è¶‹åŠ¿ï¼ˆæœ€è¿‘ 60 å¸§ï¼‰</div>
                <div class="chart" id="frameTimeChart"></div>
            </div>

            <h3>æ€§èƒ½å†å²è®°å½•</h3>
            <table class="history-table">
                <thead>
                    <tr>
                        <th>æ—¶é—´</th>
                        <th>FPS</th>
                        <th>å¸§æ—¶é—´ (ms)</th>
                        <th>èŠ‚ç‚¹æ•°</th>
                        <th>çŠ¶æ€</th>
                    </tr>
                </thead>
                <tbody id="historyBody">
                </tbody>
            </table>
        </div>
    </div>

    <script type="module">
        import { Renderer } from '../../lib/index.js';

        // åˆ›å»ºæ¸²æŸ“å™¨
        const renderer = new Renderer({
            targetFPS: 60,
            enableProfiling: true
        });

        // è·å–ç”»å¸ƒ
        const canvas = document.getElementById('canvas');

        // æ€§èƒ½å†å²æ•°æ®
        const fpsHistory = [];
        const frameTimeHistory = [];
        const performanceLog = [];
        const maxHistoryLength = 60;

        // å½“å‰è´Ÿè½½ç­‰çº§
        let currentLoadLevel = 5;
        let isPaused = false;

        try {
            // é™„åŠ åˆ°ç”»å¸ƒ
            renderer.attachTo(canvas);

            // åˆ›å»ºåˆå§‹èŠ‚ç‚¹
            createNodes(currentLoadLevel);

            // å¯åŠ¨æ¸²æŸ“å¾ªç¯
            renderer.start();

            console.log('âœ… æ€§èƒ½ç›‘æ§ç¤ºä¾‹å¯åŠ¨æˆåŠŸï¼');

            // æ›´æ–°æ€§èƒ½ç›‘æ§
            setInterval(updatePerformanceMonitor, 100);

            // å…¨å±€å‡½æ•°
            window.increaseLoad = () => {
                if (currentLoadLevel < 50) {
                    currentLoadLevel += 5;
                    addNodes(5);
                    console.log(`è´Ÿè½½å¢åŠ åˆ° ${currentLoadLevel}`);
                }
            };

            window.decreaseLoad = () => {
                if (currentLoadLevel > 0) {
                    currentLoadLevel -= 5;
                    removeNodes(5);
                    console.log(`è´Ÿè½½å‡å°‘åˆ° ${currentLoadLevel}`);
                }
            };

            window.togglePause = () => {
                isPaused = !isPaused;
                if (isPaused) {
                    renderer.pause();
                    console.log('â¸ï¸ æ¸²æŸ“å·²æš‚åœ');
                } else {
                    renderer.resume();
                    console.log('â–¶ï¸ æ¸²æŸ“å·²æ¢å¤');
                }
            };

            window.clearHistory = () => {
                fpsHistory.length = 0;
                frameTimeHistory.length = 0;
                performanceLog.length = 0;
                updateCharts();
                updateHistoryTable();
                console.log('ğŸ—‘ï¸ å†å²è®°å½•å·²æ¸…ç©º');
            };

        } catch (error) {
            console.error('âŒ åˆå§‹åŒ–å¤±è´¥:', error);
            alert('WebGL2 ä¸è¢«æ”¯æŒï¼Œè¯·ä½¿ç”¨ç°ä»£æµè§ˆå™¨');
        }

        // åˆ›å»ºèŠ‚ç‚¹
        function createNodes(count) {
            for (let i = 0; i < count; i++) {
                const node = {
                    id: `node-${Date.now()}-${i}`,
                    priority: Math.floor(Math.random() * 20),
                    visible: true,
                    render: (renderer) => {
                        const gl = renderer.gl;
                        gl.clearColor(Math.random(), Math.random(), Math.random(), 1.0);
                        gl.clear(gl.COLOR_BUFFER_BIT);

                        // æ¨¡æ‹Ÿä¸€äº›æ¸²æŸ“å·¥ä½œ
                        simulateWork(currentLoadLevel);
                    }
                };
                renderer.addNode(node);
            }
        }

        // æ·»åŠ èŠ‚ç‚¹
        function addNodes(count) {
            createNodes(count);
        }

        // ç§»é™¤èŠ‚ç‚¹
        function removeNodes(count) {
            const stats = renderer.getStats();
            if (!stats) return;

            const nodesToRemove = Math.min(count, stats.nodeCount);
            for (let i = 0; i < nodesToRemove; i++) {
                // ç§»é™¤ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ï¼ˆç®€åŒ–å¤„ç†ï¼‰
                const pipeline = renderer.pipeline;
                const info = pipeline.getVisibleNodeCount();
                if (info > 0) {
                    const nodeId = `node-${i}`;
                    renderer.removeNode(nodeId);
                }
            }
        }

        // æ¨¡æ‹Ÿæ¸²æŸ“å·¥ä½œè´Ÿè½½
        function simulateWork(loadLevel) {
            const iterations = loadLevel * 10;
            let result = 0;
            for (let i = 0; i < iterations; i++) {
                result += Math.sin(i) * Math.cos(i);
            }
            return result;
        }

        // æ›´æ–°æ€§èƒ½ç›‘æ§
        function updatePerformanceMonitor() {
            const stats = renderer.getStats();
            if (!stats) return;

            // æ›´æ–°æ˜¾ç¤º
            document.getElementById('fps').textContent = stats.fps;
            document.getElementById('frameTime').innerHTML = `${stats.frameTime.toFixed(2)}<span class="stat-unit">ms</span>`;
            document.getElementById('nodeCount').textContent = stats.nodeCount;
            document.getElementById('resourceCount').textContent = stats.resourceCount;

            // æ›´æ–°å†å²æ•°æ®
            fpsHistory.push(stats.fps);
            frameTimeHistory.push(stats.frameTime);

            // é™åˆ¶å†å²é•¿åº¦
            if (fpsHistory.length > maxHistoryLength) {
                fpsHistory.shift();
                frameTimeHistory.shift();
            }

            // æ›´æ–°å›¾è¡¨
            updateCharts();

            // è®°å½•æ€§èƒ½æ—¥å¿—ï¼ˆæ¯ 1 ç§’ä¸€æ¬¡ï¼‰
            if (performanceLog.length === 0 ||
                Date.now() - performanceLog[performanceLog.length - 1].timestamp >= 1000) {
                performanceLog.push({
                    timestamp: Date.now(),
                    fps: stats.fps,
                    frameTime: stats.frameTime,
                    nodeCount: stats.nodeCount
                });

                // é™åˆ¶æ—¥å¿—é•¿åº¦
                if (performanceLog.length > 20) {
                    performanceLog.shift();
                }

                updateHistoryTable();
            }
        }

        // æ›´æ–°å›¾è¡¨
        function updateCharts() {
            updateChart('fpsChart', fpsHistory, 60, '#4caf50');
            updateChart('frameTimeChart', frameTimeHistory, 33, '#ff9800');
        }

        // æ›´æ–°å•ä¸ªå›¾è¡¨
        function updateChart(elementId, data, maxValue, color) {
            const container = document.getElementById(elementId);
            if (!container) return;

            // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€
            if (data.length === 0) {
                container.innerHTML = '<div style="color: #999; text-align: center; padding: 20px;">æ— æ•°æ®</div>';
                return;
            }

            // è®¡ç®—æ¯ä¸ªæ¡å½¢çš„é«˜åº¦
            const bars = data.map(value => {
                const height = (value / maxValue) * 100;
                const statusClass = height >= 80 ? 'status-bad' : height >= 60 ? 'status-warning' : 'status-good';
                return `<div class="chart-bar" style="height: ${height}%;" title="${value.toFixed(1)}"></div>`;
            });

            container.innerHTML = bars.join('');
        }

        // æ›´æ–°å†å²è¡¨æ ¼
        function updateHistoryTable() {
            const tbody = document.getElementById('historyBody');
            const logData = [...performanceLog].reverse().slice(0, 10);

            if (logData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #999;">æš‚æ— è®°å½•</td></tr>';
                return;
            }

            tbody.innerHTML = logData.map(log => {
                const time = new Date(log.timestamp).toLocaleTimeString();
                const statusClass = log.fps >= 50 ? 'status-good' : log.fps >= 30 ? 'status-warning' : 'status-bad';
                const statusText = log.fps >= 50 ? 'ä¼˜ç§€' : log.fps >= 30 ? 'è‰¯å¥½' : 'éœ€è¦ä¼˜åŒ–';

                return `
                    <tr>
                        <td>${time}</td>
                        <td>${log.fps}</td>
                        <td>${log.frameTime.toFixed(2)}</td>
                        <td>${log.nodeCount}</td>
                        <td class="${statusClass}">${statusText}</td>
                    </tr>
                `;
            }).join('');
        }

        // é¡µé¢å…³é—­æ—¶æ¸…ç†
        window.addEventListener('beforeunload', () => {
            renderer.dispose();
        });
    </script>
</body>
</html>
