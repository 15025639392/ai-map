<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çŸ¢é‡å›¾å±‚ - GeoJSON ç¤ºä¾‹</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        header {
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        h1 {
            color: white;
            font-size: 24px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .main-content {
            flex: 1;
            display: flex;
            padding: 20px;
            gap: 20px;
            overflow: hidden;
        }

        #canvas-container {
            flex: 1;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        #canvas {
            flex: 1;
            display: block;
        }

        .sidebar {
            width: 320px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .panel {
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
        }

        .panel-title {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
            font-size: 14px;
        }

        .stat-label {
            color: #666;
        }

        .stat-value {
            font-weight: bold;
            color: #667eea;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            margin: 5px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        .feature-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .feature-item {
            padding: 12px;
            background: #f5f5f5;
            margin-bottom: 8px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 4px solid #667eea;
        }

        .feature-item:hover {
            background: #e0e0e0;
            transform: translateX(4px);
        }

        .feature-item.selected {
            background: #e8f5e9;
            border-left-color: #4caf50;
        }

        .feature-name {
            font-weight: bold;
            margin-bottom: 4px;
            color: #333;
        }

        .feature-type {
            font-size: 12px;
            color: #666;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            flex-direction: column;
            color: white;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.1);
            border-top: 5px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }

        .toolbar {
            background: #f5f5f5;
            padding: 15px 20px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
    </style>
</head>
<body>
    <!-- åŠ è½½ç•Œé¢ -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner"></div>
        <div>æ­£åœ¨åˆå§‹åŒ–çŸ¢é‡å›¾å±‚...</div>
        <div style="font-size: 14px; margin-top: 10px; color: #aaa;">åŠ è½½ GeoJSON æ•°æ®</div>
    </div>

    <header>
        <h1>
            <span>ğŸ”µ</span>
            çŸ¢é‡å›¾å±‚ - GeoJSON ç¤ºä¾‹
        </h1>
        <div>
            <button class="secondary" onclick="toggleFullscreen()">å…¨å±</button>
            <button class="success" onclick="loadData()">åŠ è½½æ•°æ®</button>
        </div>
    </header>

    <div class="main-content">
        <div id="canvas-container">
            <canvas id="canvas"></canvas>
            <div class="toolbar">
                <button onclick="changeStyle('default')">é»˜è®¤æ ·å¼</button>
                <button onclick="changeStyle('red')">çº¢è‰²æ ·å¼</button>
                <button onclick="changeStyle('green')">ç»¿è‰²æ ·å¼</button>
                <button onclick="changeStyle('blue')">è“è‰²æ ·å¼</button>
            </div>
        </div>

        <div class="sidebar">
            <div class="panel">
                <div class="panel-title">ğŸ“Š æ¸²æŸ“ç»Ÿè®¡</div>
                <div class="stat-item">
                    <span class="stat-label">è¦ç´ æ€»æ•°</span>
                    <span class="stat-value" id="totalFeatures">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">ç‚¹è¦ç´ </span>
                    <span class="stat-value" id="pointFeatures">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">çº¿è¦ç´ </span>
                    <span class="stat-value" id="lineFeatures">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">é¢è¦ç´ </span>
                    <span class="stat-value" id="polygonFeatures">0</span>
                </div>
            </div>

            <div class="panel">
                <div class="panel-title">ğŸ“ è¦ç´ åˆ—è¡¨</div>
                <div class="feature-list" id="featureList">
                    <!-- è¦ç´ åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>

            <div class="panel">
                <div class="panel-title">â„¹ï¸ ä¿¡æ¯</div>
                <div style="font-size: 13px; line-height: 1.6; color: #666;">
                    <p style="margin-bottom: 8px;"><strong>æ•°æ®æº:</strong> GeoJSON</p>
                    <p style="margin-bottom: 8px;"><strong>å›¾å±‚ç±»å‹:</strong> <span class="badge">Vector</span></p>
                    <p style="margin-bottom: 8px;"><strong>æ”¯æŒç±»å‹:</strong> Point, Line, Polygon</p>
                    <p><strong>äº¤äº’:</strong> ç‚¹å‡»è¦ç´ æŸ¥çœ‹è¯¦æƒ…</p>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { Renderer, VectorLayer } from '../../lib/index.js';

        // åº”ç”¨çŠ¶æ€
        const AppState = {
            renderer: null,
            canvas: null,
            vectorLayer: null,
            geojson: null,
            selectedFeature: null
        };

        // ç¤ºä¾‹ GeoJSON æ•°æ®
        const sampleGeoJSON = {
            type: 'FeatureCollection',
            features: [
                {
                    type: 'Feature',
                    geometry: {
                        type: 'Point',
                        coordinates: [116.397428, 39.90923]
                    },
                    properties: { name: 'åŒ—äº¬', type: 'city', population: 21540000 }
                },
                {
                    type: 'Feature',
                    geometry: {
                        type: 'Point',
                        coordinates: [121.473701, 31.230416]
                    },
                    properties: { name: 'ä¸Šæµ·', type: 'city', population: 24280000 }
                },
                {
                    type: 'Feature',
                    geometry: {
                        type: 'LineString',
                        coordinates: [
                            [116.397428, 39.90923],
                            [121.473701, 31.230416]
                        ]
                    },
                    properties: { name: 'åŒ—äº¬-ä¸Šæµ·é«˜é“', type: 'railway', length: '1318km' }
                },
                {
                    type: 'Feature',
                    geometry: {
                        type: 'Polygon',
                        coordinates: [[
                            [116.3, 39.85],
                            [116.5, 39.85],
                            [116.5, 39.95],
                            [116.3, 39.95]
                        ]]
                    },
                    properties: { name: 'åŒ—äº¬åŒºåŸŸ', type: 'area', area: '150kmÂ²' }
                }
            ]
        };

        // æ ·å¼é…ç½®
        const styleConfigs = {
            default: {
                fillColor: '#4CAF50',
                fillOpacity: 0.6,
                strokeColor: '#2E7D32',
                strokeWidth: 2,
                pointRadius: 10,
                pointColor: '#FF5722'
            },
            red: {
                fillColor: '#FFCDD2',
                fillOpacity: 0.6,
                strokeColor: '#EF5350',
                strokeWidth: 3,
                pointRadius: 12,
                pointColor: '#D32F2F'
            },
            green: {
                fillColor: '#C8E6C9',
                fillOpacity: 0.6,
                strokeColor: '#43A047',
                strokeWidth: 3,
                pointRadius: 12,
                pointColor: '#1B5E20'
            },
            blue: {
                fillColor: '#BBDEFB',
                fillOpacity: 0.6,
                strokeColor: '#1976D2',
                strokeWidth: 3,
                pointRadius: 12,
                pointColor: '#0D47A1'
            }
        };

        // åˆå§‹åŒ–åº”ç”¨
        async function initialize() {
            try {
                console.log('åˆ›å»ºæ¸²æŸ“å™¨...');
                AppState.renderer = new Renderer({
                    targetFPS: 60,
                    enableProfiling: true
                });

                AppState.canvas = document.getElementById('canvas');
                AppState.canvas.width = AppState.canvas.parentElement.clientWidth;
                AppState.canvas.height = AppState.canvas.parentElement.clientHeight - 70;

                console.log('åˆå§‹åŒ– WebGL2 ä¸Šä¸‹æ–‡...');
                AppState.renderer.attachTo(AppState.canvas);

                console.log('åˆ›å»ºçŸ¢é‡å›¾å±‚...');
                AppState.vectorLayer = new VectorLayer({
                    name: 'GeoJSON Layer',
                    dataSourceType: 'geojson',
                    geojsonData: sampleGeoJSON,
                    style: styleConfigs.default
                });

                AppState.vectorLayer.add(AppState.renderer);

                console.log('å¯åŠ¨æ¸²æŸ“å¾ªç¯...');
                AppState.renderer.start();

                console.log('åˆå§‹åŒ–å®Œæˆï¼');
                updateStats();
                updateFeatureList();

                // éšè—åŠ è½½ç•Œé¢
                setTimeout(() => {
                    document.getElementById('loadingOverlay').classList.add('hidden');
                }, 500);

                // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                AppState.canvas.addEventListener('click', handleCanvasClick);

            } catch (error) {
                console.error('åˆå§‹åŒ–å¤±è´¥:', error);
                alert('åˆå§‹åŒ–å¤±è´¥: ' + error.message);
            }
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            if (!AppState.vectorLayer) return;

            const stats = AppState.vectorLayer.getRenderStats();
            document.getElementById('totalFeatures').textContent = stats.featuresRendered;
            document.getElementById('pointFeatures').textContent = stats.pointsRendered;
            document.getElementById('lineFeatures').textContent = stats.linesRendered;
            document.getElementById('polygonFeatures').textContent = stats.polygonsRendered;
        }

        // æ›´æ–°è¦ç´ åˆ—è¡¨
        function updateFeatureList() {
            if (!AppState.vectorLayer) return;

            const features = AppState.vectorLayer.getFeatures();
            const list = document.getElementById('featureList');
            list.innerHTML = '';

            features.forEach(feature => {
                const item = document.createElement('div');
                item.className = 'feature-item';
                
                const geometryType = feature.geometry.type;
                const geometryName = {
                    point: 'ç‚¹',
                    multi_point: 'å¤šç‚¹',
                    line: 'çº¿',
                    multi_line: 'å¤šçº¿',
                    polygon: 'é¢',
                    multi_polygon: 'å¤šé¢'
                }[geometryType] || geometryType;

                item.innerHTML = `
                    <div class="feature-name">${feature.properties?.name || 'æœªå‘½å'}</div>
                    <div class="feature-type">${geometryName}</div>
                `;

                item.addEventListener('click', () => selectFeature(feature, item));
                list.appendChild(item);
            });
        }

        // é€‰æ‹©è¦ç´ 
        function selectFeature(feature, element) {
            // ç§»é™¤å…¶ä»–é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.feature-item.selected').forEach(el => {
                el.classList.remove('selected');
            });

            // æ·»åŠ é€‰ä¸­çŠ¶æ€
            element.classList.add('selected');
            AppState.selectedFeature = feature;

            console.log('é€‰ä¸­è¦ç´ :', feature);
        }

        // å¤„ç†ç”»å¸ƒç‚¹å‡»
        function handleCanvasClick(event) {
            if (!AppState.vectorLayer) return;

            const rect = AppState.canvas.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;

            console.log('ç‚¹å‡»åæ ‡:', x, y);

            // è¿™é‡Œå¯ä»¥å®ç°è¦ç´ æ‹¾å–
            // ç›®å‰ä»…æ˜¾ç¤ºæç¤º
            console.log('è¦ç´ æ‹¾å–åŠŸèƒ½éœ€è¦å®Œæ•´çš„ WebGL å®ç°');
        }

        // æ”¹å˜æ ·å¼
        function changeStyle(styleName) {
            if (!AppState.vectorLayer) return;

            const style = styleConfigs[styleName];
            if (style) {
                AppState.vectorLayer.setStyle(style);
                console.log('æ ·å¼å·²æ›´æ”¹ä¸º:', styleName);
            }
        }

        // åŠ è½½æ•°æ®
        function loadData() {
            if (!AppState.vectorLayer) return;

            // æ¨¡æ‹ŸåŠ è½½æ–°æ•°æ®
            const newGeoJSON = {
                type: 'FeatureCollection',
                features: [
                    {
                        type: 'Feature',
                        geometry: {
                            type: 'Point',
                            coordinates: [113.264434, 23.129162]
                        },
                        properties: { name: 'å¹¿å·', type: 'city' }
                    },
                    {
                        type: 'Feature',
                        geometry: {
                            type: 'Point',
                            coordinates: [114.169361, 22.319303]
                        },
                        properties: { name: 'æ·±åœ³', type: 'city' }
                    },
                    {
                        type: 'Feature',
                        geometry: {
                            type: 'LineString',
                            coordinates: [
                                [113.264434, 23.129162],
                                [114.169361, 22.319303]
                            ]
                        },
                        properties: { name: 'å¹¿æ·±é“è·¯', type: 'railway' }
                    }
                ]
            };

            AppState.vectorLayer.loadGeoJSON(newGeoJSON);
            updateStats();
            updateFeatureList();

            console.log('æ–°æ•°æ®å·²åŠ è½½');
            alert('å·²åŠ è½½æ–°æ•°æ®ï¼');
        }

        // å…¨å±åˆ‡æ¢
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }

        // çª—å£å¤§å°æ”¹å˜
        window.addEventListener('resize', () => {
            if (AppState.canvas && AppState.renderer) {
                const container = AppState.canvas.parentElement;
                AppState.canvas.width = container.clientWidth;
                AppState.canvas.height = container.clientHeight - 70;
                AppState.renderer.resize(AppState.canvas.width, AppState.canvas.height);
            }
        });

        // é¡µé¢å…³é—­æ—¶æ¸…ç†
        window.addEventListener('beforeunload', () => {
            if (AppState.renderer) {
                AppState.renderer.stop();
                AppState.renderer.dispose();
            }
            if (AppState.vectorLayer) {
                AppState.vectorLayer.dispose();
            }
        });

        // å¯åŠ¨åº”ç”¨
        initialize();
    </script>
</body>
</html>
