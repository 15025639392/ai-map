name: Release Gate

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  check-release-gate:
    name: Check Release Gate
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build
        run: npm run build
      
      - name: Run unit tests
        run: npm run test
      
      - name: Run compatibility tests
        run: npm run test:compatibility-run
        continue-on-error: true
      
      - name: Check release gate
        run: npm run test:release-gate
        env:
          STRICT: false
      
      - name: Upload gate results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: release-gate-results
          path: tests/compatibility-results/
          retention-days: 30
      
      - name: Comment PR with gate status
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          script: |
            const fs = require('fs');
            
            // 尝试读取发布门禁报告
            let gateStatus = '✓ PASSED';
            let gateComment = '## Release Gate Status: ✓ PASSED\n\nAll release gate checks passed.';
            
            try {
              const reportFiles = fs.readdirSync('tests/compatibility-results/')
                .filter(file => file.startsWith('release-gate-') && file.endsWith('.txt'));
              
              if (reportFiles.length > 0) {
                const latestReport = reportFiles.sort().pop();
                const reportContent = fs.readFileSync(`tests/compatibility-results/${latestReport}`, 'utf-8');
                
                // 检查是否有失败
                if (reportContent.includes('✗ FAILED')) {
                  gateStatus = '✗ FAILED';
                  gateComment = `## Release Gate Status: ✗ FAILED\n\nSome release gate checks failed. Please review the output below:\n\n\`\`\`\n${reportContent}\n\`\`\``;
                } else {
                  gateComment = `## Release Gate Status: ✓ PASSED\n\nAll release gate checks passed:\n\n\`\`\`\n${reportContent}\n\`\`\``;
                }
              }
            } catch (error) {
              gateComment = '## Release Gate Status: ⚠ UNKNOWN\n\nUnable to read release gate report.';
            }
            
            // 查找或创建评论
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Release Gate Status')
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: gateComment,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: gateComment,
              });
            }
      
      - name: Check gate status
        run: |
          # 检查发布门禁是否通过
          if [ -d "tests/compatibility-results" ]; then
            # 查找最新的发布门禁报告
            LATEST_REPORT=$(ls -t tests/compatibility-results/release-gate-*.txt 2>/dev/null | head -1)
            
            if [ -n "$LATEST_REPORT" ]; then
              # 检查报告内容
              if grep -q "Overall Status:.*PASSED" "$LATEST_REPORT"; then
                echo "✓ Release gate passed"
                exit 0
              else
                echo "✗ Release gate failed"
                exit 1
              fi
            else
              echo "⚠ No release gate report found"
              exit 1
            fi
          else
            echo "✗ No compatibility results found"
            exit 1
          fi

  coverage-check:
    name: Coverage Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build
        run: npm run build
      
      - name: Run coverage
        run: npm run test:coverage
      
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage/coverage-final.json
          flags: unittests
          name: codecov-umbrella
      
      - name: Check coverage threshold
        run: |
          # 检查覆盖率是否达标（假设至少 80%）
          COVERAGE_FILE="./coverage/coverage-summary.json"
          
          if [ -f "$COVERAGE_FILE" ]; then
            LINES_PCT=$(node -e "
              const fs = require('fs');
              const data = JSON.parse(fs.readFileSync('$COVERAGE_FILE', 'utf-8'));
              console.log(data.total.lines.pct);
            ")
            
            echo "Line coverage: ${LINES_PCT}%"
            
            if (( $(echo "$LINES_PCT >= 80" | bc -l) )); then
              echo "✓ Coverage threshold met"
              exit 0
            else
              echo "✗ Coverage below 80%"
              exit 1
            fi
          else
            echo "⚠ No coverage report found"
            exit 1
          fi
        continue-on-error: true

  final-check:
    name: Final Release Gate Check
    runs-on: ubuntu-latest
    needs: [check-release-gate, coverage-check]
    
    steps:
      - name: Final status
        run: |
          echo "========================================"
          echo "  Release Gate Final Status"
          echo "========================================"
          echo ""
          
          # 检查所有必需的检查是否通过
          if [ "${{ needs.check-release-gate.result }}" == "success" ]; then
            echo "✓ Release gate checks: PASSED"
          else
            echo "✗ Release gate checks: FAILED"
            echo ""
            echo "Release is blocked. Please fix the issues and try again."
            exit 1
          fi
          
          # 覆盖率检查失败时给出警告，但不阻止发布
          if [ "${{ needs.coverage-check.result }}" != "success" ]; then
            echo "⚠ Coverage check: FAILED (non-blocking)"
            echo "  Consider improving code coverage before release."
          else
            echo "✓ Coverage check: PASSED"
          fi
          
          echo ""
          echo "========================================"
          echo "  ✓ All release gate checks passed"
          echo "========================================"
